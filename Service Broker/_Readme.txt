Queues
    Очереди Service Broker - это скрытые таблицы, управляемые кодом Service Broker.
    
    Очереди Service Broker хранят сообщения во внутренних таблицах. Service Broker создает представление с внутренней таблицей с тем же именем, что и имя очереди.
    
    Внутренней таблицы, очередей Service Broker:
        
        SELECT sq.name AS queue_name
              ,it.name AS internal_table_name
        FROM   sys.service_queues AS sq
               INNER JOIN sys.internal_tables AS it
                       ON sq.object_id = it.parent_object_id;
    
    Очереди - это единственные объекты Service Broker, которые фактически хранят данные. Из-за этого можно создать очередь в схеме SQL Server и указать файловую группу, в которой вы хотите сохранить сообщения.
    
    Service Broker должен временно хранить сообщения до того, как они достигнут своего конечного адресата, он помещает их в представление sys.transmission_queue.
    Service Broker может отправить сообщение непосредственно в очередь назначения, если очередь назначения находится в том же экземпляре SQL Server, что и отправитель.
    
    Сообщениния попадают в sys.transmission_queue в следующих случаях:
        - Пункт назначения находится в другом экземпляре SQL Server.
        - Целевая очередь отключена - STATUS = OFF.
        - Service Broker отключен в базе данных, где находится очередь назначения. Обычно это связано с подключением или восстановлением базы данных без опции ENABLE_BROKER.
        - Пункт назначения неизвестен. 
        
Services
    
Dialogs
    Параметр LIFETIME устанавливает время (сек.), в течение которого диалог может оставаться активным.
    Если истекает срок службы LIFETIME, сообщение http://schemas.microsoft.com/SQL/ServiceBroker/Error помещаются в очереди на обеих конечных точках диалога, cостояние обеих конечных точек изменяется на ERROR.
    Важно помнить, что диалог все еще существует до тех пор, пока обе конечные точки не закончат его, поэтому ваш код должен обрабатывать сообщения об ошибках.
    
    Завершение диалога:
        
        END CONVERSATION @dialog_handle;
        
        Отмечает конечную точку как закрытую, удаляет все сообщения, все еще находящиеся в очереди, и отправляет сообщение типа http://schemas.microsoft.com/SQL/ServiceBroker/EndDialog в противоположную конечную точку диалога.
        Когда противоположная конечная точка принимает сообщение EndDialog, она может продолжать обрабатывать все сообщения, все еще находящиеся в очереди, но не может отправлять сообщения, cообщения в sys.transmission_queue, которые не были доставлены в противоположную конечную точку диалога, удаляются. 
        Когда конечная точка обработала какие-либо выдающиеся сообщения, она должна выполнить любую необходимую очистку и затем выполнить команду END CONVERSATION, чтобы завершить свою сторону разговора. 
        После того, как обе конечные точки завершат диалог, Service Broker очистит состояние диалога.
    
    Закончить диалог, когда произошла неустранимая ошибка:
    
        END CONVERSATION @dialog_handle WITH ERROR = 31472
            DESCRIPTION = 'Invalid Purchase Order number furnished';
    
        Когда диалог завершается с параметром ошибки, сообщение типа http://schemas.microsoft.com/SQL/ServiceBroker/Error отправляется в противоположную конечную точку вместо сообщения о завершении разговора.
    
    Избавиться от осиротевших диалогов:
        
        END CONVERSATION @dialog_handle WITH CLEANUP;
        
        Эта команда безоговорочно завершает диалог, не отправляя сообщение на противоположную конечную точку, и отбрасывает любые необработанные сообщения.